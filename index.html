<!DOCTYPE html>
<html>
<head>
  <title>Exam Timer</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin-top: 50px; }
    input { margin: 5px; padding: 5px; }
    #timer { font-size: 2em; margin-top: 20px; }
  </style>
</head>
<body>
  <h1>Exam Timer</h1>

  <label>10-mark Questions: <input type="number" id="q10" min="0" value="2"></label><br>
  <label>10-mark Duration (min): <input type="number" id="d10" min="0.1" step="0.1" value="0.5"></label><br>
  <label>15-mark Questions: <input type="number" id="q15" min="0"></label><br>
  <label>15-mark Duration (min): <input type="number" id="d15" min="1" value="11"></label><br>
  <label>20-mark Questions: <input type="number" id="q20" min="0"></label><br>
  <label>20-mark Duration (min): <input type="number" id="d20" min="1" value="15"></label><br>
  <button onclick="startTimerSequence()">Start</button>

  <div id="question"></div>
  <div id="timer"></div>

  <audio id="endSound" src="piep-33489.mp3" preload="auto"></audio>
  <audio id="midSound" src="700-hz-beeps-86815.mp3" preload="auto"></audio>

  <script>
    const numSecond = 60;
    const tuneLength = 14;      // duration of end beep in seconds
    const midTuneLength = 4;    // duration of mid beep in seconds
    const offset = 2;

    const endSound = document.getElementById('endSound');
    const midSound = document.getElementById('midSound');

    let audioUnlocked = false;
    let questionQueue = [];

    function unlockAudio() {
      if (audioUnlocked) return;
      // Resume AudioContext if available
      if (window.AudioContext || window.webkitAudioContext) {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        ctx.resume();
      }
      // Play and pause each sound to unlock playback on Safari
      [midSound, endSound].forEach(sound => {
        const playPromise = sound.play();
        if (playPromise !== undefined) {
          playPromise.then(() => sound.pause()).catch(() => {});
        }
      });
      audioUnlocked = true;
    }

    function startTimerSequence() {
      unlockAudio();
      const q10 = parseInt(document.getElementById('q10').value || 0);
      const q15 = parseInt(document.getElementById('q15').value || 0);
      const q20 = parseInt(document.getElementById('q20').value || 0);
      const d10 = parseFloat(document.getElementById('d10').value || 0.5);
      const d15 = parseFloat(document.getElementById('d15').value || 11);
      const d20 = parseFloat(document.getElementById('d20').value || 15);

      questionQueue = [];
      for (let i = 0; i < q10; i++) questionQueue.push({ num: i + 1, duration: d10 });
      for (let i = 0; i < q15; i++) questionQueue.push({ num: 11 + i, duration: d15 });
      for (let i = 0; i < q20; i++) questionQueue.push({ num: 21 + i, duration: d20 });

      runNext();
    }

    function runNext() {
      if (questionQueue.length === 0) {
        document.getElementById('question').textContent = 'All done!';
        document.getElementById('timer').textContent = '';
        return;
      }
      const q = questionQueue.shift();
      document.getElementById('question').textContent = `Q${q.num}`;
      startCountdown(Math.floor(q.duration * numSecond));
    }

    function startCountdown(seconds) {
      const effective = seconds - tuneLength - midTuneLength - offset;
      const midPoint = Math.floor(effective / 2);
      let count = effective;
      const timerDisplay = document.getElementById('timer');
      let interval;

      function tick() {
        timerDisplay.textContent = `${count} seconds left`;

        if (count === midPoint) {
          clearInterval(interval);
          midSound.play();
          count--;
          setTimeout(() => {
            interval = setInterval(tick, 1000);
          }, midTuneLength * 1000);
          return;
        }

        count--;

        if (count < 0) {
          clearInterval(interval);
          endSound.play();
          setTimeout(runNext, tuneLength * 1000);
        }
      }

      interval = setInterval(tick, 1000);
    }
  </script>
</body>
</html>
