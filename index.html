<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Timer</title>
  <style>
    /* Base Styles */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0 0 40px 0; /* Added bottom padding for clear visibility */
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #f5f5f5;
    }
    h1 {
      margin: 20px 0;
      font-size: 1.5rem;
    }
    #minutes, #seconds {
      font-size: 3rem;
      margin: 10px;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      font-size: 1rem;
      margin: 0 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Exam Timer</h1>
  <div id="time-display">
    <span id="minutes">00</span>:<span id="seconds">00</span>
  </div>
  <div class="controls">
    <button id="start-btn">Start</button>
    <button id="reset-btn">Reset</button>
  </div>
  <audio id="mid-sound" src="piep-33489.mp3"></audio>
  <audio id="end-sound" src="700-hz-beeps-86815.mp3"></audio>

  <script>
    let interval;
    let timeLeft = 0;
    let audioUnlocked = false;

    const midSound = document.getElementById('mid-sound');
    const endSound = document.getElementById('end-sound');
    const minutesDisplay = document.getElementById('minutes');
    const secondsDisplay = document.getElementById('seconds');
    const startBtn = document.getElementById('start-btn');
    const resetBtn = document.getElementById('reset-btn');

    startBtn.addEventListener('click', () => {
      if (!audioUnlocked) unlockAudio();
      if (interval) return;
      timeLeft = 300; // 5 minutes in seconds
      updateDisplay();
      startCountdown();
    });

    resetBtn.addEventListener('click', () => {
      clearInterval(interval);
      interval = null;
      timeLeft = 0;
      updateDisplay();
    });

    function unlockAudio() {
      if (audioUnlocked) return;

      // 1) Resume / unlock AudioContext
      const AC = window.AudioContext || window.webkitAudioContext;
      if (AC) {
        const ctx = new AC();
        ctx.resume().then(() => {
          // 2) Play & immediately stop a tiny oscillator to unlock
          const osc = ctx.createOscillator();
          osc.connect(ctx.destination);
          osc.start();
          osc.stop(ctx.currentTime + 0.001);
        });
      }

      // mark as done
      audioUnlocked = true;
    }

    function updateDisplay() {
      const mins = String(Math.floor(timeLeft / 60)).padStart(2, '0');
      const secs = String(timeLeft % 60).padStart(2, '0');
      minutesDisplay.textContent = mins;
      secondsDisplay.textContent = secs;
    }

    function startCountdown() {
      let midPlay = false;
      const tuneLength = 10; // length of mid beep in seconds

      function tick() {
        timeLeft--;
        updateDisplay();

        // Play the mid-sound at halfway point
        if (!midPlay && timeLeft === 300 - tuneLength) {
          midPlay = true;
          midSound.pause();
          midSound.currentTime = 0;
          midSound.play().catch(() => {});
        }

        if (timeLeft < 0) {
          clearInterval(interval);
          endSound.pause();
          endSound.currentTime = 0;
          endSound.play().catch(() => {});
          setTimeout(runNext, tuneLength*1000);
        }
      }

      interval = setInterval(tick, 1000);
    }
  </script>
</body>
</html>
